<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Test AJAX Editar Usuario</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { 
            border: 1px solid #ddd; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 5px; 
        }
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            cursor: pointer; 
            background: #007bff; 
            color: white; 
            border: none; 
            border-radius: 3px; 
        }
        button:hover { background: #0056b3; }
        .response { 
            background: #f4f4f4; 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 3px; 
            white-space: pre-wrap; 
        }
        .error { background: #ffe0e0; }
        .success { background: #e0ffe0; }
    </style>
</head>
<body>
    <h1>🔍 Test de Actualización de Usuarios - AJAX</h1>
    
    <div class="test-section">
        <h2>1. Prueba Simple de Actualización</h2>
        <p>ID Usuario a editar: <input type="number" id="userId" value="1" /></p>
        <button onclick="testSimpleUpdate()">Probar UPDATE Simple</button>
        <div id="result1" class="response"></div>
    </div>
    
    <div class="test-section">
        <h2>2. Prueba con FormData Completo</h2>
        <form id="testForm">
            <p>ID: <input type="number" name="id_usuario" value="1" /></p>
            <p>Usuario: <input type="text" name="usuario" value="test_user" /></p>
            <p>Nombre: <input type="text" name="nombre_completo" value="Test Usuario" /></p>
            <p>Email: <input type="email" name="email" value="test@test.com" /></p>
            <p>Rol: 
                <select name="rol">
                    <option value="admin">admin</option>
                    <option value="admin_sucursal">admin_sucursal</option>
                    <option value="usuario" selected>usuario</option>
                </select>
            </p>
            <p>Sucursal: <input type="number" name="id_sucursal" value="1" /></p>
            <button type="button" onclick="testFormData()">Probar con FormData</button>
        </form>
        <div id="result2" class="response"></div>
    </div>
    
    <div class="test-section">
        <h2>3. Prueba Directa al Controlador</h2>
        <button onclick="testDirectController()">Test Directo</button>
        <div id="result3" class="response"></div>
    </div>
    
    <div class="test-section">
        <h2>4. Verificar Sesión</h2>
        <button onclick="checkSession()">Verificar Sesión</button>
        <div id="result4" class="response"></div>
    </div>

    <script>
        const BASE_URL = 'http://localhost/fudo/';
        
        function log(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            element.className = 'response ' + (isError ? 'error' : '');
            element.textContent = message;
        }
        
        async function testSimpleUpdate() {
            const id = document.getElementById('userId').value;
            log('result1', 'Enviando petición...');
            
            try {
                const formData = new FormData();
                formData.append('id_usuario', id);
                formData.append('usuario', 'test_' + Date.now());
                formData.append('nombre_completo', 'Test Update');
                formData.append('email', 'test@example.com');
                formData.append('rol', 'usuario');
                formData.append('id_sucursal', '1');
                
                console.log('Enviando a:', BASE_URL + 'usuarios/editar/' + id);
                
                const response = await fetch(BASE_URL + 'usuarios/editar/' + id, {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                
                const text = await response.text();
                console.log('Respuesta raw:', text);
                
                try {
                    const data = JSON.parse(text);
                    log('result1', 'Respuesta: ' + JSON.stringify(data, null, 2));
                } catch (e) {
                    log('result1', 'Respuesta no es JSON:\n' + text, true);
                }
            } catch (error) {
                log('result1', 'Error: ' + error.message, true);
                console.error(error);
            }
        }
        
        async function testFormData() {
            const form = document.getElementById('testForm');
            const formData = new FormData(form);
            const id = formData.get('id_usuario');
            
            log('result2', 'Enviando FormData...');
            
            // Log FormData contents
            console.log('FormData contents:');
            for (let [key, value] of formData.entries()) {
                console.log(`  ${key}: ${value}`);
            }
            
            try {
                const response = await fetch(BASE_URL + 'usuarios/editar/' + id, {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                
                const text = await response.text();
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                console.log('Response text:', text);
                
                try {
                    const data = JSON.parse(text);
                    log('result2', 'Respuesta: ' + JSON.stringify(data, null, 2));
                } catch (e) {
                    log('result2', 'Respuesta no es JSON:\n' + text, true);
                }
            } catch (error) {
                log('result2', 'Error: ' + error.message, true);
                console.error(error);
            }
        }
        
        async function testDirectController() {
            log('result3', 'Probando controlador directamente...');
            
            try {
                // Primero intentar obtener la lista de usuarios
                const response = await fetch(BASE_URL + 'admin/usuarios', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                const text = await response.text();
                
                if (response.status === 200) {
                    log('result3', 'Controlador accesible. Status: ' + response.status);
                } else {
                    log('result3', 'Error de acceso. Status: ' + response.status + '\nVerifica que estés logueado', true);
                }
            } catch (error) {
                log('result3', 'Error: ' + error.message, true);
            }
        }
        
        async function checkSession() {
            log('result4', 'Verificando sesión...');
            
            // Crear un pequeño script PHP para verificar sesión
            const checkUrl = BASE_URL + 'check_session.php';
            
            try {
                const response = await fetch(checkUrl, {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const text = await response.text();
                    log('result4', 'Respuesta: ' + text);
                } else {
                    log('result4', 'No se pudo verificar la sesión. Crea el archivo check_session.php');
                }
            } catch (error) {
                log('result4', 'Para verificar la sesión, crea un archivo check_session.php en la raíz del proyecto');
            }
        }
        
        // Log inicial
        console.log('Test page loaded. Base URL:', BASE_URL);
    </script>
</body>
</html>
